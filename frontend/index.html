<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1A0033">
    <title>NeoBank & Chrome Slots - Neotropolis</title>
    <link rel="stylesheet" href="css/cyberpunk.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div v-if="loading" class="loading-screen">
            <div class="glitch-text" data-text="INITIALIZING">INITIALIZING</div>
            <div class="loading-bar"></div>
        </div>

        <!-- Login/Register Screen -->
        <div v-if="!user && !loading" class="auth-screen">
            <div class="neon-container">
                <h1 class="glitch-text" data-text="NEOTROPOLIS">NEOTROPOLIS</h1>
                <h2 class="subtitle">NeoBank & Chrome Slots</h2>
                
                <div class="tabs">
                    <button @click="authMode = 'login'" :class="{ active: authMode === 'login' }">LOGIN</button>
                    <button @click="authMode = 'register'" :class="{ active: authMode === 'register' }">REGISTER</button>
                </div>

                <!-- Login Form -->
                <form v-if="authMode === 'login'" @submit.prevent="login" class="auth-form">
                    <div class="input-group">
                        <label>Character Name</label>
                        <input v-model="loginForm.character_name" type="text" required placeholder="Enter your character name">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input v-model="loginForm.password" type="password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn-primary">ACCESS SYSTEM</button>
                </form>

                <!-- Register Form -->
                <form v-if="authMode === 'register'" @submit.prevent="register" class="auth-form">
                    <div class="input-group">
                        <label>Character Name</label>
                        <input v-model="registerForm.character_name" type="text" required placeholder="Choose a character name">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input v-model="registerForm.password" type="password" required minlength="6" placeholder="Minimum 6 characters">
                    </div>
                    <div class="input-group">
                        <label>Faction (Optional)</label>
                        <select v-model="registerForm.faction">
                            <option value="">No Faction</option>
                            <option value="CorpSec">CorpSec</option>
                            <option value="Runners">Runners</option>
                            <option value="Syndicate">Syndicate</option>
                            <option value="Technocrats">Technocrats</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary">CREATE ACCOUNT</button>
                </form>

                <div v-if="error" class="error-message">{{ error }}</div>
            </div>
        </div>

        <!-- Main Application (after login) -->
        <div v-if="user && !loading" class="main-app">
            <!-- Navigation -->
            <nav class="top-nav">
                <div class="nav-brand">NEOTROPOLIS 2025</div>
                <div class="nav-links">
                    <button @click="currentView = 'bank'" :class="{ active: currentView === 'bank' }">
                        üí≥ BANK
                    </button>
                    <button @click="currentView = 'casino'" :class="{ active: currentView === 'casino' }">
                        üé∞ CASINO
                    </button>
                    <button @click="currentView = 'profile'" :class="{ active: currentView === 'profile' }">
                        üë§ PROFILE
                    </button>
                    <button v-if="user.is_admin" @click="currentView = 'admin'" :class="{ active: currentView === 'admin' }">
                        ‚öôÔ∏è ADMIN
                    </button>
                    <button @click="logout" class="logout-btn">EXIT</button>
                </div>
            </nav>

            <!-- Bank View -->
            <div v-if="currentView === 'bank'" class="view-container">
                <div class="balance-display">
                    <div class="balance-label">ACCOUNT BALANCE</div>
                    <div class="balance-amount">¬§{{ formatBalance(user.balance) }}</div>
                </div>

                <div class="account-info neon-container">
                    <h3>CITIZEN REGISTRY</h3>
                    <div class="info-row">
                        <span class="label">Name:</span>
                        <span class="value">{{ user.character_name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Account:</span>
                        <span class="value account-number">{{ user.account_number }}</span>
                        <button @click="copyToClipboard(user.account_number)" class="btn-small">COPY</button>
                    </div>
                    <div class="info-row" v-if="user.faction">
                        <span class="label">Faction:</span>
                        <span class="value">{{ user.faction }}</span>
                    </div>
                </div>

                <!-- Transfer Form -->
                <div class="neon-container">
                    <h3>TRANSFER FUNDS</h3>
                    <form @submit.prevent="transfer" class="transfer-form">
                        <div class="input-group">
                            <label>Recipient Account</label>
                            <input v-model="transferForm.to_account" type="text" required placeholder="NC-XXXX-XXXX">
                        </div>
                        <div class="input-group">
                            <label>Amount</label>
                            <input v-model.number="transferForm.amount" type="number" step="0.01" min="0.01" required placeholder="0.00">
                        </div>
                        <div class="input-group">
                            <label>Memo (Optional)</label>
                            <input v-model="transferForm.memo" type="text" maxlength="140" placeholder="Transaction note">
                        </div>
                        <button type="submit" class="btn-primary">SEND CREDITS</button>
                    </form>
                </div>

                <!-- Transaction History -->
                <div class="neon-container">
                    <h3>TRANSACTION LOG</h3>
                    <div class="search-box">
                        <input v-model="searchQuery" @input="searchTransactions" type="text" placeholder="Search transactions...">
                    </div>
                    <div class="transaction-list">
                        <div v-if="transactions.length === 0" class="no-data">No transactions yet</div>
                        <div v-for="tx in transactions" :key="tx.id" class="transaction-item">
                            <div class="tx-header">
                                <span :class="['tx-type', tx.to_account === user.account_number ? 'incoming' : 'outgoing']">
                                    {{ tx.to_account === user.account_number ? '‚Üì INCOMING' : '‚Üë OUTGOING' }}
                                </span>
                                <span class="tx-amount" :class="{ positive: tx.to_account === user.account_number }">
                                    {{ tx.to_account === user.account_number ? '+' : '-' }}¬§{{ formatBalance(tx.amount) }}
                                </span>
                            </div>
                            <div class="tx-details">
                                <div>{{ tx.to_account === user.account_number ? 'From' : 'To' }}: 
                                    <strong>{{ tx.to_account === user.account_number ? tx.from_name : tx.to_name }}</strong>
                                    ({{ tx.to_account === user.account_number ? tx.from_account : tx.to_account }})
                                </div>
                                <div v-if="tx.memo" class="tx-memo">{{ tx.memo }}</div>
                                <div class="tx-time">{{ formatTimestamp(tx.timestamp) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile View -->
            <div v-if="currentView === 'profile'" class="view-container">
                <h2 class="section-title">USER PROFILE</h2>
                
                <div class="neon-container">
                    <h3>Profile Picture</h3>
                    <div class="profile-picture-display">
                        <div class="current-profile-pic">{{ user.profile_picture || 'üë§' }}</div>
                        <p style="color: var(--text-secondary); margin-bottom: 10px;">Choose an emoji:</p>
                        <div class="emoji-grid">
                            <div v-for="emoji in profileEmojis" :key="emoji" @click="selectProfilePicture(emoji); updateProfile()" class="emoji-option">
                                {{ emoji }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="neon-container">
                    <h3>Faction</h3>
                    <select v-model="user.faction" @change="updateProfile" class="faction-select">
                        <option value="">No Faction</option>
                        <option value="CorpSec">CorpSec</option>
                        <option value="Runners">Runners</option>
                        <option value="Syndicate">Syndicate</option>
                        <option value="Technocrats">Technocrats</option>
                    </select>
                </div>

                <div class="neon-container">
                    <h3>Change Password</h3>
                    <form @submit.prevent="changePassword" class="password-form">
                        <div class="input-group">
                            <label>Current Password</label>
                            <input v-model="passwordForm.currentPassword" type="password" required>
                        </div>
                        <div class="input-group">
                            <label>New Password</label>
                            <input v-model="passwordForm.newPassword" type="password" required minlength="6">
                        </div>
                        <div class="input-group">
                            <label>Confirm New Password</label>
                            <input v-model="passwordForm.confirmPassword" type="password" required minlength="6">
                        </div>
                        <button type="submit" class="btn-primary">UPDATE PASSWORD</button>
                    </form>
                </div>

                <div class="neon-container">
                    <h3>Account Information</h3>
                    <div class="account-info-grid">
                        <div class="info-item">
                            <label>Character Name</label>
                            <div class="value">{{ user.character_name }}</div>
                        </div>
                        <div class="info-item">
                            <label>Account Number</label>
                            <div class="value">{{ user.account_number }}</div>
                        </div>
                        <div class="info-item">
                            <label>Balance</label>
                            <div class="value">¬§{{ formatBalance(user.balance) }}</div>
                        </div>
                        <div class="info-item">
                            <label>Member Since</label>
                            <div class="value">{{ new Date(user.created_at).toLocaleDateString() }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Casino View -->
            <div v-if="currentView === 'casino'" class="view-container">
                <div class="balance-display">
                    <div class="balance-label">ACCOUNT BALANCE</div>
                    <div class="balance-amount">¬§{{ formatBalance(user.balance) }}</div>
                </div>

                <div class="casino-selector">
                    <button @click="selectedGame = 'glitch'" :class="{ active: selectedGame === 'glitch' }" class="game-btn">
                        <h3>GLITCH GRID</h3>
                        <p>3-Reel Classic ‚Ä¢ Simple Payline</p>
                    </button>
                    <button @click="selectedGame = 'starlight'" :class="{ active: selectedGame === 'starlight' }" class="game-btn">
                        <h3>STARLIGHT SMUGGLER</h3>
                        <p>5-Reel ‚Ä¢ 9 Paylines ‚Ä¢ Bonus Spins</p>
                    </button>
                </div>

                <!-- Glitch Grid -->
                <div v-if="selectedGame === 'glitch'" class="slot-machine glitch-grid">
                    <h2 class="game-title glitch-text" data-text="GLITCH GRID">GLITCH GRID</h2>
                    <div class="slot-reels">
                        <div class="reel" v-for="(symbol, index) in glitchReels" :key="index">
                            <div class="symbol">{{ symbol }}</div>
                        </div>
                    </div>
                    <div class="bet-controls">
                        <button @click="decreaseBet('glitch')" class="btn-control">-</button>
                        <div class="bet-display">BET: ¬§{{ glitchBet }}</div>
                        <button @click="increaseBet('glitch')" class="btn-control">+</button>
                    </div>
                    <button @click="spinGlitch" :disabled="spinning" class="btn-spin">
                        {{ spinning ? 'SPINNING...' : 'SPIN' }}
                    </button>
                    <div v-if="lastResult" class="result-display" :class="{ win: lastResult.win_amount > 0 }">
                        <div v-if="lastResult.win_amount > 0">
                            üéâ WIN! {{ lastResult.win_multiplier }}x = ¬§{{ formatBalance(lastResult.win_amount) }}
                        </div>
                        <div v-else>
                            Try again!
                        </div>
                    </div>
                    <button @click="showPaytable = !showPaytable" class="btn-secondary">
                        {{ showPaytable ? 'HIDE' : 'SHOW' }} PAYTABLE
                    </button>
                    <div v-if="showPaytable" class="paytable neon-container">
                        <h4>PAYTABLE</h4>
                        <div class="payout-row">üè¢ üè¢ üè¢ = 100x</div>
                        <div class="payout-row">üíÄ üíÄ üíÄ = 50x</div>
                        <div class="payout-row">„äôÔ∏è „äôÔ∏è „äôÔ∏è = 40x</div>
                        <div class="payout-row">01 01 01 = 30x</div>
                        <div class="payout-row">üîå üîå üîå = 20x</div>
                        <div class="payout-row">üè¢ = WILD (substitutes any)</div>
                    </div>
                </div>

                <!-- Starlight Smuggler -->
                <div v-if="selectedGame === 'starlight'" class="slot-machine starlight-smuggler">
                    <h2 class="game-title glitch-text" data-text="STARLIGHT SMUGGLER">STARLIGHT SMUGGLER</h2>
                    <div class="slot-grid">
                        <div v-for="(row, rowIdx) in starlightGrid" :key="rowIdx" class="grid-row">
                            <div v-for="(symbol, colIdx) in row" :key="colIdx" class="symbol">
                                {{ symbol }}
                            </div>
                        </div>
                    </div>
                    <div class="bet-controls">
                        <button @click="decreaseBet('starlight')" class="btn-control">-</button>
                        <div class="bet-display">
                            <div>BET/LINE: ¬§{{ starlightBet }}</div>
                            <div class="small">Total: ¬§{{ starlightBet * 9 }}</div>
                        </div>
                        <button @click="increaseBet('starlight')" class="btn-control">+</button>
                    </div>
                    <button @click="spinStarlight" :disabled="spinning" class="btn-spin">
                        {{ spinning ? 'SPINNING...' : 'SPIN' }}
                    </button>
                    <div v-if="lastResult" class="result-display" :class="{ win: lastResult.win_amount > 0 }">
                        <div v-if="lastResult.win_amount > 0">
                            üéâ WIN on {{ lastResult.winning_lines.length }} line(s)! 
                            {{ lastResult.win_multiplier }}x = ¬§{{ formatBalance(lastResult.win_amount) }}
                        </div>
                        <div v-if="lastResult.bonus_spins > 0" class="bonus-alert">
                            ‚≠ê BONUS! {{ lastResult.bonus_spins }} FREE SPINS AWARDED!
                        </div>
                        <div v-if="lastResult.win_amount === 0 && !lastResult.bonus_spins">
                            Try again!
                        </div>
                    </div>
                    <button @click="showPaytable = !showPaytable" class="btn-secondary">
                        {{ showPaytable ? 'HIDE' : 'SHOW' }} PAYTABLE
                    </button>
                    <div v-if="showPaytable" class="paytable neon-container">
                        <h4>PAYTABLE (per line)</h4>
                        <div class="payout-row">üíé x5 = 250x | x4 = 75x | x3 = 20x</div>
                        <div class="payout-row">üöÄ x5 = 200x | x4 = 50x | x3 = 15x</div>
                        <div class="payout-row">üó∫Ô∏è x5 = 150x | x4 = 40x | x3 = 12x</div>
                        <div class="payout-row">üî´ x5 = 100x | x4 = 30x | x3 = 10x</div>
                        <div class="payout-row">‚≠ê x5 = 80x | x4 = 25x | x3 = 8x</div>
                        <div class="payout-row">üåÄ x3+ anywhere = 5 FREE SPINS!</div>
                    </div>
                </div>
            </div>

            <!-- Admin View (if admin) -->
            <div v-if="currentView === 'admin' && user.is_admin" class="view-container admin-panel">
                <h2 class="section-title">ADMIN CONTROL PANEL</h2>
                
                <!-- User Search -->
                <div class="neon-container">
                    <h3>USER LOOKUP</h3>
                    <div class="search-box">
                        <input v-model="adminSearch" @input="searchUsers" type="text" placeholder="Search by name or account...">
                    </div>
                    <div class="user-results">
                        <div v-for="u in searchResults" :key="u.account_number" class="user-card">
                            <div class="user-header">
                                <strong>{{ u.character_name }}</strong>
                                <span class="account-number">{{ u.account_number }}</span>
                                <span v-if="u.is_admin" class="admin-badge">‚≠ê ADMIN</span>
                            </div>
                            <div class="user-info-row">
                                <div class="info-item">
                                    <label>Balance:</label>
                                    <span>¬§{{ formatBalance(u.balance) }}</span>
                                </div>
                                <div class="info-item">
                                    <label>Faction:</label>
                                    <span>{{ u.faction || 'None' }}</span>
                                </div>
                            </div>
                            <div class="user-actions">
                                <button @click="openAdjustBalance(u)" class="btn-small btn-primary">
                                    üí∞ ADJUST BALANCE
                                </button>
                                <label class="admin-toggle">
                                    <input type="checkbox" :checked="u.is_admin" @change="toggleAdminStatus(u)" :disabled="u.account_number === user.account_number">
                                    <span class="checkbox-label">Admin Privileges</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Balance Adjustment Modal -->
                <div v-if="adjustingUser" class="modal">
                    <div class="modal-content neon-container">
                        <h3>ADJUST BALANCE</h3>
                        <p>Account: {{ adjustingUser.account_number }} ({{ adjustingUser.character_name }})</p>
                        <p>Current Balance: ¬§{{ formatBalance(adjustingUser.balance) }}</p>
                        <form @submit.prevent="adjustBalance">
                            <div class="input-group">
                                <label>Amount (+ to credit, - to debit)</label>
                                <input v-model.number="adjustAmount" type="number" step="0.01" required>
                            </div>
                            <div class="input-group">
                                <label>Reason</label>
                                <input v-model="adjustReason" type="text" required>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn-primary">CONFIRM</button>
                                <button type="button" @click="adjustingUser = null" class="btn-secondary">CANCEL</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- API Keys -->
                <div class="neon-container">
                    <h3>API KEY MANAGEMENT</h3>
                    <button @click="createApiKey" class="btn-primary">GENERATE NEW KEY</button>
                    <div class="api-key-list">
                        <div v-for="key in apiKeys" :key="key.id" class="api-key-item">
                            <div class="key-info">
                                <code>{{ key.key_value }}</code>
                                <span class="key-desc">{{ key.description }}</span>
                            </div>
                            <button @click="revokeApiKey(key.id)" class="btn-danger">REVOKE</button>
                        </div>
                    </div>
                </div>

                <!-- Casino Controls -->
                <div class="neon-container">
                    <h3>CASINO ODDS CONFIGURATION</h3>
                    <p style="color: #888; margin-bottom: 15px; font-size: 0.9em;">
                        Control the Return-To-Player (RTP) percentage. Higher = More player-friendly. 
                        Real casinos: 85-96% | Recommended generous setting: 98-105%
                    </p>
                    <div v-for="game in casinoGames" :key="game.game_name" class="game-control">
                        <div class="game-info">
                            <strong>{{ game.game_name.toUpperCase().replace('_', ' ') }}</strong>
                            <label>
                                <input type="checkbox" v-model="game.is_enabled" @change="updateGameConfig(game)">
                                Enabled
                            </label>
                        </div>
                        <div class="payout-control">
                            <label>RTP (Return To Player) %:</label>
                            <input type="number" v-model.number="game.payout_percentage" @change="updateGameConfig(game)" min="50" max="150" step="0.5">
                            <span class="payout-indicator" :class="{
                                'payout-low': game.payout_percentage < 85,
                                'payout-normal': game.payout_percentage >= 85 && game.payout_percentage < 98,
                                'payout-generous': game.payout_percentage >= 98 && game.payout_percentage < 105,
                                'payout-very-generous': game.payout_percentage >= 105
                            }">
                                {{ game.payout_percentage < 85 ? 'üî¥ Very Tight' : 
                                   game.payout_percentage < 98 ? 'üü° Standard Casino' :
                                   game.payout_percentage < 105 ? 'üü¢ Player Friendly' : 'üíö Very Generous' }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Faction Management -->
                <div class="neon-container">
                    <h3>FACTION MANAGEMENT</h3>
                    <button @click="loadFactions" class="btn-primary">REFRESH FACTIONS</button>
                    <div class="faction-list">
                        <div v-for="faction in factions" :key="faction.faction" class="faction-card">
                            <div class="faction-header">
                                <strong>{{ faction.faction }}</strong>
                                <span class="faction-stats">{{ faction.user_count }} users ‚Ä¢ ¬§{{ formatBalance(faction.total_balance) }}</span>
                            </div>
                            <button @click="openAddFactionCredits(faction.faction)" class="btn-small btn-success">
                                ADD CREDITS
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Faction Credits Modal -->
                <div v-if="factionCreditsModal" class="modal">
                    <div class="modal-content neon-container">
                        <h3>ADD CREDITS TO FACTION</h3>
                        <p>Faction: <strong>{{ factionCreditsModal }}</strong></p>
                        <form @submit.prevent="addFactionCredits">
                            <div class="input-group">
                                <label>Amount to Add</label>
                                <input v-model.number="factionCreditsAmount" type="number" step="0.01" required>
                            </div>
                            <div class="input-group">
                                <label>Reason</label>
                                <input v-model="factionCreditsReason" type="text" placeholder="e.g., Faction bonus" required>
                            </div>
                            <div class="button-group">
                                <button type="submit" class="btn-primary">CONFIRM</button>
                                <button type="button" @click="factionCreditsModal = null" class="btn-secondary">CANCEL</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Export Users -->
                <div class="neon-container">
                    <h3>DATA EXPORT</h3>
                    <p>Export all user accounts and balances to CSV file</p>
                    <button @click="exportUsersCSV" class="btn-primary">
                        üì• DOWNLOAD CSV EXPORT
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container">
            <div v-for="(toast, index) in toasts" :key="index" class="toast" :class="toast.type">
                {{ toast.message }}
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
